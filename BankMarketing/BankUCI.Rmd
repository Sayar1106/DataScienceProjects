---
title: "R Notebook"
output:
  html_document: default
  html_notebook: default
---

### Loading Libraries

```{r}

library(DMwR)
library(caret)
library(C50)
library(rpart)
```
### Reading in the data

```{r}

bank<-read.csv('/Users/Banner/Desktop/Data Science Projects/bank-additional/bank-additional-full.csv', header = T, sep = ";")

bank<-subset(x = bank, select = -duration)

```

### Exploratory Data Analysis

```{r}

str(bank)

summary(bank)

```

```{r}

sum(is.na(bank))

```


```{r}

head(bank)

tail(bank)

```

### Converting into factor

```{r}

cat_attr<-colnames(bank[,sapply(bank,is.factor)])

num_attr<-colnames(setdiff(x = bank, y = bank[,cat_attr]))

```

### Train-Test split

```{r}

set.seed(123)
train_rows<-createDataPartition(y = bank$y, p = 0.7, list = F)

train_data<-bank[train_rows,]

test_data<-bank[-train_rows,]

```

```{r}
modelLookup('glm')
```

### Center and Scale

```{r}

std_model<-preProcess(x = train_data[,num_attr], method = c("center","scale"))


train_data<-predict(object = std_model, newdata = train_data)
test_data<-predict(object = std_model, newdata = test_data)

```

### Training the logistic regression model

```{r}

log_model<-glm(y~.,data = train_data, family = "binomial")

summary(log_model)

```

#### Predicting log_model on train data

```{r}

log_train_preds<-predict(object = log_model, type = "response")

log_train_preds<-ifelse(log_train_preds>0.5,"yes","no")

confusionMatrix(log_train_preds,train_data$y,positive = "yes")

```

####  Predicting log_model on test data

```{r}

log_test_preds<-predict(object = log_model, newdata = test_data,type = "response")

log_test_preds<-ifelse(log_test_preds>0.5, "yes", "no")

confusionMatrix(log_test_preds,test_data$y,positive = "yes")

```

#### Checking for variable importance

```{r}

colnames(train_data)
varImp(object = log_model)

```

```{r}
table(train_data$loan)
```

### Random Forest model

```{r}

control_param<-trainControl(method = "none", classProbs = T)

rf_model<-train(y~.,data = train_data, method = "rf", trControl = control_param, metric = "accuracy", family = "binomial")

rf_model$finalModel

```

#### Predicting rf_model on train data

```{r}

rf_train_preds<-predict(object = log_model, type = "raw")

confusionMatrix(train_preds,train_data$y)

```

#### Predicting rf_model on test data

```{r}

rf_test_preds<-predict(object = rf_model, newdata = test_data, type = "raw")

confusionMatrix(rf_test_preds,test_data$y)

```

### Knn Model

```{r}

knn_model<-train(y~.,data = train_data, method = "knn", trControl = control_param, metric = "accuracy")

```

#### Predicting knn_model on train data

```{r}
knn_train_preds<-predict(object = knn_model, type = "raw")

confusionMatrix(knn_train_preds,train_data$y, positive = "yes")
```
#### Predicting knn_model on test data

```{r}
knn_test_preds<-predict(object = knn_model, newdata = test_data, type = "raw")

confusionMatrix(knn_test_preds,test_data$y, positive = "yes")
```
### CART Decision Tree model

```{r}
cart_model<-rpart(y~.,data = train_data, method = "class")
summary(cart_model)
```

### Predicting on train_data

```{r}

cart_train_preds<-predict(object = cart_model,type = "class")

confusionMatrix(data = cart_train_preds,train_data$y, positive = "yes")

```

### Predicting on test_data

```{r}

cart_test_preds<-predict(object = cart_model,newdata = test_data, type = "class")

confusionMatrix(data = cart_test_preds,test_data$y, positive = "yes")

```
### Combine all preds

```{r}

train_preds_all_models<-data.frame(CART = cart_train_preds, GLM = log_train_preds, KNN = knn_train_preds)

test_preds_all_models<-data.frame(CART = cart_test_preds, GLM = log_test_preds, KNN = knn_test_preds)
```

### Add original target to all preds

```{r}

train_preds_all_models<-cbind(train_preds_all_models, y = train_data$y)

test_preds_all_models<-cbind(test_preds_all_models, y = test_data$y)
```

### Ensemble model (Stacking)

```{r}
ensemble_model<-glm(y~. ,data = train_preds_all_models, family = "binomial")

summary(ensemble_model)
```

### Predicting on train_data

```{r}

ensemble_train_preds<-predict(ensemble_model, train_preds_all_models, type = "response")

ensemble_train_preds<-ifelse(ensemble_train_preds>0.5,"yes","no")
confusionMatrix(ensemble_train_preds,train_preds_all_models$y)

```
### Predicting on test_data

```{r}

ensemble_test_preds<-predict(ensemble_model, test_preds_all_models, type = "response")

ensemble_test_preds<-ifelse(ensemble_test_preds>0.5,"yes","no")
confusionMatrix(ensemble_test_preds,test_preds_all_models$y, positive = "yes")

```

